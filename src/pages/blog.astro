---
import { getCollection } from "astro:content";
import "@styles/global.css";
import Header from "@components/Header.astro";

const pageTitle = "ブログ";
const allPosts = await getCollection("blog");
const sortedPosts = allPosts.sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
);

// 全てのタグを抽出
const allTags = [...new Set(allPosts.flatMap(post => post.data.tags))];
---

<html lang="ja">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="viewport" content="width=device-width" />
		<meta name="generator" content={Astro.generator} />
		<title>{pageTitle}</title>
	</head>
	<body class="bg-gray-50 min-h-screen">
		<Header currentPath="/blog" />
		<main class="p-8">
			<div class="max-w-4xl mx-auto">
				<h1 class="text-3xl font-bold mb-8">{pageTitle}</h1>
			
			<!-- 検索・フィルターエリア -->
			<div class="mb-8 space-y-4">
				<!-- 検索ボックス -->
				<div>
					<input 
						id="search-input"
						type="text" 
						placeholder="記事を検索..."
						class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
					/>
				</div>
				
				<!-- タグフィルター -->
				<div>
					<p class="text-sm text-gray-600 mb-2">タグで絞り込み:</p>
					<div class="flex flex-wrap gap-2">
						<button 
							id="tag-all"
							class="tag-filter px-3 py-1 rounded-full text-sm border transition-colors bg-blue-500 text-white"
							data-tag="all"
						>
							全て
						</button>
						{allTags.map((tag) => (
							<button 
								class="tag-filter px-3 py-1 rounded-full text-sm border transition-colors border-gray-300 hover:bg-gray-100"
								data-tag={tag}
							>
								{tag}
							</button>
						))}
					</div>
				</div>
				
				<!-- 結果表示 -->
				<div id="results-count" class="text-sm text-gray-600"></div>
			</div>

			<!-- 記事一覧 -->
			<div id="posts-container">
				{sortedPosts.length === 0 ? (
					<p class="text-gray-600">ブログ記事がまだありません。</p>
				) : (
					<div class="grid gap-6" id="posts-list">
						{sortedPosts.map((post) => (
							<article 
								class="post-item border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow"
								data-title={post.data.title.toLowerCase()}
								data-description={post.data.description?.toLowerCase() || ''}
								data-tags={post.data.tags.join(',')}
							>
								<header class="mb-4">
									<h2 class="text-xl font-semibold mb-2">
										<a href={`/blog/${post.data.slug}`} class="text-blue-600 hover:text-blue-800">
											{post.data.title}
										</a>
									</h2>
									<div class="text-sm text-gray-500">
										<time datetime={post.data.pubDate.toISOString()}>
											{post.data.pubDate.toLocaleDateString('ja-JP')}
										</time>
										{post.data.updatedDate && (
											<span class="ml-2">
												(更新: {post.data.updatedDate.toLocaleDateString('ja-JP')})
											</span>
										)}
									</div>
								</header>
								{post.data.description && (
									<p class="text-gray-700 mb-4">{post.data.description}</p>
								)}
								{post.data.tags && post.data.tags.length > 0 && (
									<div class="flex flex-wrap gap-2">
										{post.data.tags.map((tag) => (
											<span class="bg-gray-100 text-gray-800 px-2 py-1 rounded text-sm">
												{tag}
											</span>
										))}
									</div>
								)}
							</article>
						))}
					</div>
				)}
				
				<!-- 結果がない場合のメッセージ -->
				<div id="no-results" class="hidden">
					<p class="text-gray-600 text-center py-8">検索条件に一致する記事が見つかりませんでした。</p>
				</div>
				</div>
			</div>
		</main>
		
		<script>
			// フィルタリング機能
			const searchInput = document.getElementById('search-input');
			const tagFilters = document.querySelectorAll('.tag-filter');
			const postItems = document.querySelectorAll('.post-item');
			const resultsCount = document.getElementById('results-count');
			const noResults = document.getElementById('no-results');
			const postsList = document.getElementById('posts-list');
			
			let currentTag = 'all';
			let currentSearch = '';
			
			// 検索機能
			searchInput.addEventListener('input', (e) => {
				currentSearch = e.target.value.toLowerCase();
				filterPosts();
			});
			
			// タグフィルター機能
			tagFilters.forEach(button => {
				button.addEventListener('click', (e) => {
					// アクティブなボタンのスタイルを更新
					tagFilters.forEach(btn => {
						btn.classList.remove('bg-blue-500', 'text-white');
						btn.classList.add('border-gray-300', 'hover:bg-gray-100');
					});
					
					e.target.classList.add('bg-blue-500', 'text-white');
					e.target.classList.remove('border-gray-300', 'hover:bg-gray-100');
					
					currentTag = e.target.dataset.tag;
					filterPosts();
				});
			});
			
			// フィルタリング実行
			function filterPosts() {
				let visibleCount = 0;
				
				postItems.forEach(post => {
					const title = post.dataset.title;
					const description = post.dataset.description;
					const tags = post.dataset.tags.split(',');
					
					// 検索条件チェック
					const matchesSearch = currentSearch === '' || 
						title.includes(currentSearch) || 
						description.includes(currentSearch);
					
					// タグ条件チェック
					const matchesTag = currentTag === 'all' || tags.includes(currentTag);
					
					if (matchesSearch && matchesTag) {
						post.style.display = 'block';
						visibleCount++;
					} else {
						post.style.display = 'none';
					}
				});
				
				// 結果数表示
				resultsCount.textContent = `${visibleCount}件の記事が見つかりました`;
				
				// 結果がない場合の表示切り替え
				if (visibleCount === 0) {
					postsList.style.display = 'none';
					noResults.classList.remove('hidden');
				} else {
					postsList.style.display = 'block';
					noResults.classList.add('hidden');
				}
			}
			
			// 初期表示
			filterPosts();
		</script>
	</body>
</html>