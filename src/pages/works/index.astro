---
import { getCollection } from "astro:content";
import Layout from "@layouts/Layout.astro";
import { predefinedTags } from "@config/tags";

// 全ての作品を取得
const allWorks = await getCollection("works");
const sortedWorks = allWorks.sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
);

const pageTitle = "WORKS";
const displayTags = predefinedTags.works;
---

<Layout 
  title={`${pageTitle} - UBOPAGE`}
  description="WRITE SOMETHING ANYWAY"
  currentPath="/works"
  backgroundPattern="main"
  ogImage={new URL('/og/works.png', Astro.site || 'https://uboar.net').href}
>
  <div class="container">
    <div class="py-8">
      <h1 class="text-4xl font-bold mb-8">WORKS</h1>
			
      <!-- 検索・フィルターエリア -->
      <div class="card mb-8" style="animation-delay: 0.1s">
        <!-- 検索ボックス -->
        <div class="mb-4">
          <input 
            id="search-input"
            type="text" 
            placeholder="プロジェクトを検索..."
            class="w-full px-4 py-3 bg-bg-secondary border border-orange-main/20 rounded-lg text-text-primary placeholder-text-muted focus:outline-none focus:border-orange-main focus:ring-2 focus:ring-orange-main/20 transition-all"
          />
        </div>
        
        <!-- タグフィルター -->
        <div>
          <p class="text-sm text-text-muted mb-3">タグで絞り込み:</p>
          
          <!-- タグ入力 -->
          <div class="mb-3">
            <input 
              id="tag-input"
              type="text" 
              placeholder="タグを入力..."
              class="w-full px-4 py-2 bg-bg-secondary border border-orange-main/20 rounded-lg text-text-primary placeholder-text-muted focus:outline-none focus:border-orange-main focus:ring-2 focus:ring-orange-main/20 transition-all text-sm"
            />
          </div>
          
          <!-- プリセットタグボタン -->
          <div class="flex flex-wrap gap-2">
            <button 
              id="tag-all"
              class="tag-filter btn btn-primary btn-sm"
              data-tag="all"
            >
              全て
            </button>
            {displayTags.map((tag) => (
              <button 
                class="tag-filter btn btn-outline btn-sm"
                data-tag={tag}
              >
                {tag}
              </button>
            ))}
          </div>
        </div>
      </div>

      <!-- プロジェクト一覧 -->
      <div id="works-container">
        {sortedWorks.length === 0 ? (
          <div class="card text-center py-12">
            <p class="text-text-secondary text-lg">NONE</p>
          </div>
        ) : (
          <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4" id="works-list">
            {sortedWorks.map((work: any, index: number) => (
              work.data.projectUrl ? (
                <a 
                  href={work.data.projectUrl} 
                  target="_blank" 
                  rel="noopener noreferrer"
                  class="work-item card h-full flex flex-col motion-preset-slide-up-sm hover:scale-[1.02] transition-transform duration-300 group p-3"
                  data-title={work.data.title.toLowerCase()}
                  data-description={work.data.description?.toLowerCase() || ''}
                  data-tags={work.data.tags.join(',')}
                >
                  {/* プロジェクト画像 */}
                  {work.data.image && (
                    <div class="mb-3">
                      <img 
                        src={work.data.image} 
                        alt={work.data.title}
                        class="w-full aspect-square object-cover rounded-lg group-hover:brightness-110 transition-all duration-300"
                        loading="lazy"
                      />
                    </div>
                  )}
                  
                  <div class="flex-1 flex flex-col">
                    <header class="mb-2">
                      <p class="text-sm font-semibold text-orange-main mb-1 group-hover:text-orange-light transition-colors line-clamp-2">
                        {work.data.title}
                      </p>
                      
                      <div class="text-xs text-text-muted">
                        <time datetime={work.data.pubDate.toISOString()}>
                          {work.data.pubDate.toLocaleDateString('ja-JP')}
                        </time>
                      </div>
                    </header>
                    
                    {work.data.description && (
                      <p class="text-xs text-text-secondary mb-3 flex-1 line-clamp-2">{work.data.description}</p>
                    )}
                    
                    {/* タグ */}
                    {work.data.tags && work.data.tags.length > 0 && (
                      <div>
                        <div class="flex flex-wrap gap-2">
                          {work.data.tags.slice(0, 2).map((tag: string) => (
                            <span class="project-card-tech-tag text-xs">
                              {tag}
                            </span>
                          ))}
                          {work.data.tags.length > 2 && (
                            <span class="text-xs text-text-muted">
                              +{work.data.tags.length - 2}
                            </span>
                          )}
                        </div>
                      </div>
                    )}
                  </div>
                </a>
              ) : (
                <a 
                  href={`/works/${work.data.slug}`}
                  class="work-item card h-full flex flex-col motion-preset-slide-up-sm hover:scale-[1.02] transition-transform duration-300 group p-3"
                  data-title={work.data.title.toLowerCase()}
                  data-description={work.data.description?.toLowerCase() || ''}
                  data-tags={work.data.tags.join(',')}
                >
                  {/* プロジェクト画像 */}
                  {work.data.image && (
                    <div class="mb-3">
                      <img 
                        src={work.data.image} 
                        alt={work.data.title}
                        class="w-full aspect-square object-cover rounded-lg group-hover:brightness-110 transition-all duration-300"
                        loading="lazy"
                      />
                    </div>
                  )}
                  
                  <div class="flex-1 flex flex-col">
                    <header class="mb-2">
                      <p class="text-sm font-semibold text-orange-main mb-1 group-hover:text-orange-light transition-colors line-clamp-2">
                        {work.data.title}
                      </p>
                      
                      <div class="text-xs text-text-muted">
                        <time datetime={work.data.pubDate.toISOString()}>
                          {work.data.pubDate.toLocaleDateString('ja-JP')}
                        </time>
                      </div>
                    </header>
                    
                    {work.data.description && (
                      <p class="text-xs text-text-secondary mb-3 flex-1 line-clamp-2">{work.data.description}</p>
                    )}
                    
                    {/* タグ */}
                    {work.data.tags && work.data.tags.length > 0 && (
                      <div>
                        <div class="flex flex-wrap gap-2">
                          {work.data.tags.slice(0, 2).map((tag: string) => (
                            <span class="project-card-tech-tag text-xs">
                              {tag}
                            </span>
                          ))}
                          {work.data.tags.length > 2 && (
                            <span class="text-xs text-text-muted">
                              +{work.data.tags.length - 2}
                            </span>
                          )}
                        </div>
                      </div>
                    )}
                  </div>
                </a>
              )
            ))}
          </div>
        )}
				
        <!-- 結果がない場合のメッセージ -->
        <div id="no-results" class="hidden">
          <div class="card text-center py-12">
            <p class="text-text-secondary text-lg">検索条件に一致するプロジェクトが見つかりませんでした。</p>
          </div>
        </div>
      </div>

      <!-- ページネーション -->
      <div id="pagination-container" class="pagination">
        <!-- JavaScriptで動的に生成 -->
      </div>
    </div>
  </div>
		
  <script>
    // グローバル設定
    const PAGE_SIZE = 20;
    let currentPage = 1;
    let currentTag = 'all';
    let currentSearch = '';
    let currentTagSearch = '';
    
    // DOM要素
    const searchInput = document.getElementById('search-input');
    const tagInput = document.getElementById('tag-input') as HTMLInputElement;
    const tagFilters = document.querySelectorAll('.tag-filter');
    const workItems = document.querySelectorAll('.work-item');
    const noResults = document.getElementById('no-results');
    const worksList = document.getElementById('works-list');
    const paginationContainer = document.getElementById('pagination-container');
    
    // 全ての作品を配列として保持
    const allWorks = Array.from(workItems).map(item => ({
      element: item as HTMLElement,
      title: (item as HTMLElement).dataset.title || '',
      description: (item as HTMLElement).dataset.description || '',
      tags: ((item as HTMLElement).dataset.tags?.split(',') || [])
    }));
    
    // 検索機能
    searchInput?.addEventListener('input', (e) => {
      currentSearch = (e.target as HTMLInputElement).value.toLowerCase();
      currentPage = 1; // 検索時は1ページ目に戻る
      updateDisplay();
    });
    
    // タグ検索機能
    tagInput?.addEventListener('input', (e) => {
      currentTagSearch = (e.target as HTMLInputElement).value.toLowerCase();
      currentTag = 'all'; // タグ検索時はボタン選択をリセット
      
      // ボタンのスタイルをリセット
      tagFilters.forEach(btn => {
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-outline');
      });
      document.getElementById('tag-all')?.classList.add('btn-primary');
      document.getElementById('tag-all')?.classList.remove('btn-outline');
      
      currentPage = 1;
      updateDisplay();
    });
    
    // タグフィルター機能
    tagFilters.forEach(button => {
      button.addEventListener('click', (e) => {
        // アクティブなボタンのスタイルを更新
        tagFilters.forEach(btn => {
          btn.classList.remove('btn-primary');
          btn.classList.add('btn-outline');
        });
        
        const target = e.target as HTMLElement;
        target.classList.add('btn-primary');
        target.classList.remove('btn-outline');
        
        currentTag = target.dataset.tag || 'all';
        currentTagSearch = ''; // タグボタン選択時はタグ検索をクリア
        if (tagInput) tagInput.value = '';
        currentPage = 1; // タグ変更時は1ページ目に戻る
        updateDisplay();
      });
    });
    
    // フィルタリングされた作品を取得
    function getFilteredWorks() {
      return allWorks.filter(work => {
        // 検索条件チェック
        const matchesSearch = currentSearch === '' || 
          work.title.includes(currentSearch) || 
          work.description.includes(currentSearch);
        
        // タグ条件チェック
        let matchesTag = true;
        if (currentTagSearch !== '') {
          // タグ検索モード
          matchesTag = work.tags.some(tag => 
            tag.toLowerCase().includes(currentTagSearch)
          );
        } else if (currentTag !== 'all') {
          // タグボタン選択モード
          matchesTag = work.tags.includes(currentTag);
        }
        
        return matchesSearch && matchesTag;
      });
    }
    
    // ページネーションを生成
    function generatePagination(totalItems: number) {
      const totalPages = Math.ceil(totalItems / PAGE_SIZE);
      
      if (totalPages <= 1) {
        paginationContainer!.innerHTML = '';
        return;
      }
      
      let html = '<div class="pagination__container">';
      
      // ページ番号
      html += '<div class="pagination__pages">';
      
      // ページ番号の生成ロジック
      const maxVisible = 5;
      let start = Math.max(1, currentPage - Math.floor(maxVisible / 2));
      let end = Math.min(totalPages, start + maxVisible - 1);
      
      if (end - start + 1 < maxVisible) {
        start = Math.max(1, end - maxVisible + 1);
      }
      
      if (start > 1) {
        html += `<button class="btn btn-outline btn-sm pagination__button pagination__page" data-page="1">1</button>`;
        if (start > 2) {
          html += '<span class="pagination__ellipsis">...</span>';
        }
      }
      
      for (let i = start; i <= end; i++) {
        if (i === currentPage) {
          html += `<span class="btn btn-primary btn-sm pagination__button pagination__current">${i}</span>`;
        } else {
          html += `<button class="btn btn-outline btn-sm pagination__button pagination__page" data-page="${i}">${i}</button>`;
        }
      }
      
      if (end < totalPages) {
        if (end < totalPages - 1) {
          html += '<span class="pagination__ellipsis">...</span>';
        }
        html += `<button class="btn btn-outline btn-sm pagination__button pagination__page" data-page="${totalPages}">${totalPages}</button>`;
      }
      
      html += '</div>';
      
      html += '</div>';
      html += `<div class="pagination__info">
        <span class="text-sm text-text-muted">${totalPages} ページ中 ${currentPage} ページ目</span>
      </div>`;
      
      paginationContainer!.innerHTML = html;
      
      // ページネーションボタンのイベントリスナー
      paginationContainer!.querySelectorAll('[data-page]').forEach(button => {
        button.addEventListener('click', (e) => {
          const page = parseInt((e.currentTarget as HTMLElement).dataset.page!);
          currentPage = page;
          updateDisplay();
          // ページ上部にスクロール
          window.scrollTo({ top: 0, behavior: 'smooth' });
        });
      });
    }
    
    // 表示を更新
    function updateDisplay() {
      const filteredWorks = getFilteredWorks();
      const totalItems = filteredWorks.length;
      
      // ページネーション計算
      const startIndex = (currentPage - 1) * PAGE_SIZE;
      const endIndex = startIndex + PAGE_SIZE;
      const worksToShow = filteredWorks.slice(startIndex, endIndex);
      
      // 全ての作品を非表示
      allWorks.forEach(work => {
        work.element.style.display = 'none';
      });
      
      // 現在のページの作品を表示とアニメーション遅延設定
      worksToShow.forEach((work, index) => {
        const element = work.element;
        element.style.display = 'block';
        
        // アニメーションをリセット
        element.classList.remove('motion-preset-slide-up-sm');
        void element.offsetWidth; // リフローを強制
        element.classList.add('motion-preset-slide-up-sm');
        
        // アニメーション遅延を動的に設定
        element.style.animationDelay = `${0.1 + index * 0.1}s`;
      });
      
      // 結果がない場合の表示切り替え
      if (totalItems === 0) {
        if (worksList) worksList.style.display = 'none';
        if (noResults) noResults.classList.remove('hidden');
      } else {
        if (worksList) worksList.style.display = 'grid';
        if (noResults) noResults.classList.add('hidden');
      }
      
      // ページネーションを生成
      generatePagination(totalItems);
    }
    
    // 初期表示
    updateDisplay();
  </script>

  <style>
    .pagination {
      margin-top: 3rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
    }

    .pagination__container {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
      justify-content: center;
    }

    .pagination__pages {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .pagination__button {
      min-width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      border-radius: 0.5rem;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .pagination__button:hover:not(.pagination__current) {
      transform: translateY(-1px);
    }

    .pagination__current {
      pointer-events: none;
    }

    .pagination__ellipsis {
      padding: 0.5rem;
      color: var(--text-muted);
      font-weight: 500;
      user-select: none;
    }

    .pagination__prev,
    .pagination__next {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      min-width: auto;
    }

    .pagination__info {
      text-align: center;
    }

    /* レスポンシブ対応 */
    @media (max-width: 639px) {
      .pagination__container {
        gap: 0.25rem;
      }
      
      .pagination__button {
        min-width: 40px;
        height: 40px;
        font-size: 0.875rem;
      }
      
      .pagination__prev,
      .pagination__next {
        padding: 0.5rem 0.75rem;
      }
    }
  </style>
</Layout>