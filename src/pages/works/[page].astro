---
import { getCollection } from "astro:content";
import Layout from "@layouts/Layout.astro";
import Pagination from "@components/Pagination.astro";

export async function getStaticPaths({ paginate }: { paginate: any }) {
  const allWorks = await getCollection("works");
  const sortedWorks = allWorks.sort(
    (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
  );

  return paginate(sortedWorks, { pageSize: 6 });
}

const { page } = Astro.props as { page: any };
const pageTitle = page.currentPage === 1 ? "WORKS" : `WORKS - ページ ${page.currentPage}`;

// 全てのタグを抽出（フィルター用）
const allWorks = await getCollection("works");
const allTags = [...new Set(allWorks.flatMap(work => work.data.tags))];
---

<Layout 
  title={`${pageTitle} - UBOPAGE`}
  description="WRITE SOMETHING ANYWAY"
  currentPath="/works"
  backgroundPattern="main"
>
  <div class="container">
    <div class="py-8">
      <h1 class="text-4xl font-bold mb-8">WORKS</h1>
			
      <!-- 検索・フィルターエリア -->
      <div class="card mb-8" style="animation-delay: 0.1s">
        <!-- 検索ボックス -->
        <div class="mb-4">
          <input 
            id="search-input"
            type="text" 
            placeholder="プロジェクトを検索..."
            class="w-full px-4 py-3 bg-bg-secondary border border-orange-main/20 rounded-lg text-text-primary placeholder-text-muted focus:outline-none focus:border-orange-main focus:ring-2 focus:ring-orange-main/20 transition-all"
          />
        </div>
        
        <!-- タグフィルター -->
        <div>
          <p class="text-sm text-text-muted mb-3">タグで絞り込み:</p>
          <div class="flex flex-wrap gap-2">
            <button 
              id="tag-all"
              class="tag-filter btn btn-primary btn-sm"
              data-tag="all"
            >
              全て
            </button>
            {allTags.map((tag: string) => (
              <button 
                class="tag-filter btn btn-outline btn-sm"
                data-tag={tag}
              >
                {tag}
              </button>
            ))}
          </div>
        </div>
      </div>

      <!-- プロジェクト一覧 -->
      <div id="works-container">
        {page.data.length === 0 ? (
          <div class="card text-center py-12">
            <p class="text-text-secondary text-lg">NONE</p>
          </div>
        ) : (
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="works-list">
            {page.data.map((work: any, index: number) => (
              work.data.projectUrl ? (
                <a 
                  href={work.data.projectUrl} 
                  target="_blank" 
                  rel="noopener noreferrer"
                  class="work-item card h-full flex flex-col motion-preset-slide-up-sm hover:scale-[1.02] transition-transform duration-300 group block"
                  data-title={work.data.title.toLowerCase()}
                  data-description={work.data.description?.toLowerCase() || ''}
                  data-tags={work.data.tags.join(',')}
                  style={`animation-delay: ${0.2 + index * 0.1}s`}
                >
                  {/* プロジェクト画像 */}
                  {work.data.image && (
                    <div class="mb-4">
                      <img 
                        src={work.data.image.url} 
                        alt={work.data.image.alt}
                        class="w-full h-48 object-cover rounded-lg group-hover:brightness-110 transition-all duration-300"
                      />
                    </div>
                  )}
                  
                  <div class="flex-1 flex flex-col">
                    <header class="mb-4">
                      <h3 class="text-lg font-semibold text-orange-main mb-2 group-hover:text-orange-light transition-colors">
                        {work.data.title}
                      </h3>
                      
                      <div class="text-sm text-text-muted mb-3">
                        <time datetime={work.data.pubDate.toISOString()}>
                          {work.data.pubDate.toLocaleDateString('ja-JP')}
                        </time>
                        {work.data.updatedDate && (
                          <span class="ml-2">
                            (更新: {work.data.updatedDate.toLocaleDateString('ja-JP')})
                          </span>
                        )}
                      </div>
                    </header>
                    
                    {work.data.description && (
                      <p class="text-text-secondary mb-4 flex-1">{work.data.description}</p>
                    )}
                    
                    {/* タグ */}
                    {work.data.tags && work.data.tags.length > 0 && (
                      <div>
                        <div class="flex flex-wrap gap-2">
                          {work.data.tags.map((tag: string) => (
                            <span class="project-card-tech-tag">
                              {tag}
                            </span>
                          ))}
                        </div>
                      </div>
                    )}
                  </div>
                </a>
              ) : (
                <a 
                  href={`/works/${work.data.slug}`}
                  class="work-item card h-full flex flex-col motion-preset-slide-up-sm hover:scale-[1.02] transition-transform duration-300 group block"
                  data-title={work.data.title.toLowerCase()}
                  data-description={work.data.description?.toLowerCase() || ''}
                  data-tags={work.data.tags.join(',')}
                  style={`animation-delay: ${0.2 + index * 0.1}s`}
                >
                  {/* プロジェクト画像 */}
                  {work.data.image && (
                    <div class="mb-4">
                      <img 
                        src={work.data.image.url} 
                        alt={work.data.image.alt}
                        class="w-full h-48 object-cover rounded-lg group-hover:brightness-110 transition-all duration-300"
                      />
                    </div>
                  )}
                  
                  <div class="flex-1 flex flex-col">
                    <header class="mb-4">
                      <h3 class="text-lg font-semibold text-orange-main mb-2 group-hover:text-orange-light transition-colors">
                        {work.data.title}
                      </h3>
                      
                      <div class="text-sm text-text-muted mb-3">
                        <time datetime={work.data.pubDate.toISOString()}>
                          {work.data.pubDate.toLocaleDateString('ja-JP')}
                        </time>
                        {work.data.updatedDate && (
                          <span class="ml-2">
                            (更新: {work.data.updatedDate.toLocaleDateString('ja-JP')})
                          </span>
                        )}
                      </div>
                    </header>
                    
                    {work.data.description && (
                      <p class="text-text-secondary mb-4 flex-1">{work.data.description}</p>
                    )}
                    
                    {/* タグ */}
                    {work.data.tags && work.data.tags.length > 0 && (
                      <div>
                        <div class="flex flex-wrap gap-2">
                          {work.data.tags.map((tag: string) => (
                            <span class="project-card-tech-tag">
                              {tag}
                            </span>
                          ))}
                        </div>
                      </div>
                    )}
                  </div>
                </a>
              )
            ))}
          </div>
        )}
				
        <!-- 結果がない場合のメッセージ -->
        <div id="no-results" class="hidden">
          <div class="card text-center py-12">
            <p class="text-text-secondary text-lg">検索条件に一致するプロジェクトが見つかりませんでした。</p>
          </div>
        </div>
      </div>

      <!-- ページネーション -->
      <Pagination 
        currentPage={page.currentPage || 1}
        totalPages={page.lastPage || 1}
        baseUrl="/works"
      />
    </div>
  </div>
		
  <script>
    // フィルタリング機能
    const searchInput = document.getElementById('search-input');
    const tagFilters = document.querySelectorAll('.tag-filter');
    const workItems = document.querySelectorAll('.work-item');
    const noResults = document.getElementById('no-results');
    const worksList = document.getElementById('works-list');
    
    let currentTag = 'all';
    let currentSearch = '';
    
    // 検索機能
    searchInput?.addEventListener('input', (e) => {
      const target = e.target as HTMLInputElement;
      currentSearch = target.value.toLowerCase();
      filterWorks();
    });
    
    // タグフィルター機能
    tagFilters.forEach(button => {
      button.addEventListener('click', (e) => {
        // アクティブなボタンのスタイルを更新
        tagFilters.forEach(btn => {
          btn.classList.remove('btn-primary');
          btn.classList.add('btn-outline');
        });
        
        const target = e.target as HTMLElement;
        target.classList.add('btn-primary');
        target.classList.remove('btn-outline');
        
        currentTag = target.dataset.tag || 'all';
        filterWorks();
      });
    });
    
    // フィルタリング実行
    function filterWorks() {
      let visibleCount = 0;
      
      workItems.forEach(work => {
        const workElement = work as HTMLElement;
        const title = workElement.dataset.title || '';
        const description = workElement.dataset.description || '';
        const tags = workElement.dataset.tags?.split(',') || [];
        
        // 検索条件チェック
        const matchesSearch = currentSearch === '' || 
          title.includes(currentSearch) || 
          description.includes(currentSearch);
        
        // タグ条件チェック
        const matchesTag = currentTag === 'all' || tags.includes(currentTag);
        
        if (matchesSearch && matchesTag) {
          workElement.style.display = 'block';
          visibleCount++;
        } else {
          workElement.style.display = 'none';
        }
      });
      
      // 結果がない場合の表示切り替え
      if (visibleCount === 0) {
        if (worksList) worksList.style.display = 'none';
        if (noResults) noResults.classList.remove('hidden');
      } else {
        if (worksList) worksList.style.display = 'grid';
        if (noResults) noResults.classList.add('hidden');
      }
    }
    
    // 初期表示
    filterWorks();
  </script>
</Layout>