---
import { getCollection, render } from 'astro:content';
import Layout from '@layouts/Layout.astro';
import TableOfContents from '@components/TableOfContents.astro';
import SocialShare from '@components/SocialShare.astro';
import { extractTocFromMarkdown } from '@utils/toc';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map(post => ({
    params: { slug: post.data.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await render(post);

// 目次を抽出
const toc = extractTocFromMarkdown(post.body || '');

// 構造化データ用の画像URL
const articleImage = post.data.image || new URL(`/og/blog/${post.data.slug}.png`, Astro.site || 'https://uboar.net').href;
---

<Layout 
  title={`${post.data.title} - UBOPAGE`}
  description={post.data.description}
  currentPath={`/blog/${post.data.slug}`}
  backgroundPattern="main"
  ogImage={new URL(`/og/blog/${post.data.slug}.png`, Astro.site || 'https://uboar.net').href}
>
  <div class="container">
    <div class="py-8">
      <nav class="mb-8">
        <a href="/blog/" class="btn btn-outline btn-sm motion-preset-slide-right-sm">← ブログ一覧に戻る</a>
      </nav>
    
      <div class="lg:flex lg:gap-8 xl:gap-12">
        <!-- メインコンテンツ -->
        <article class="lg:w-3/4 min-w-0">
          <header class="mb-12 motion-preset-slide-up-sm border-b">
            <h1 class="text-3xl sm:text-4xl lg:text-5xl font-bold mb-6 leading-tight break-words">{post.data.title}</h1>
            
            <div class="flex flex-wrap items-center gap-4 text-text-muted mb-6 text-sm sm:text-base">
              <time class="blog-card-date" datetime={post.data.pubDate.toISOString()}>
                公開日: {post.data.pubDate.toLocaleDateString('ja-JP')}
              </time>
              {post.data.updatedDate && (
                <span>
                  更新日: {post.data.updatedDate.toLocaleDateString('ja-JP')}
                </span>
              )}
            </div>
            
            {post.data.description && (
              <p class="text-lg sm:text-xl text-text-secondary mb-8 leading-relaxed">{post.data.description}</p>
            )}
            
            {post.data.tags && post.data.tags.length > 0 && (
              <div class="flex flex-wrap gap-2 mb-8">
                {post.data.tags.map((tag) => (
                  <span class="blog-card-tag">
                    {tag}
                  </span>
                ))}
              </div>
            )}
            
            {post.data.image && (
              <div class="mb-8">
                <img 
                  src={post.data.image} 
                  alt={post.data.title}
                  class="w-full h-auto rounded-xl shadow-lg max-w-full"
                  loading="lazy"
                />
              </div>
            )}
          </header>
          
          <div class="prose prose-base sm:prose-lg lg:prose-xl prose-invert max-w-full motion-preset-slide-up-sm overflow-hidden" style="animation-delay: 0.2s">
            <Content />
          </div>
          
          <SocialShare 
            title={post.data.title}
            url={`${Astro.site || 'https://ubo-site.vercel.app/'}blog/${post.data.slug}`}
            description={post.data.description}
          />
        </article>
        
        <!-- サイドバー（目次） -->
        <aside class="lg:w-1/4 lg:min-w-0 mt-12 lg:mt-0">
          <div class="lg:sticky lg:top-24 motion-preset-slide-up-sm" style="animation-delay: 0.3s">
            <TableOfContents toc={toc} />
          </div>
        </aside>
      </div>
    </div>
  </div>
  
  <!-- 記事用構造化データ -->
  <script type="application/ld+json" is:inline>
    {
      "@context": "https://schema.org",
      "@type": "BlogPosting",
      "headline": "${post.data.title}",
      "description": "${post.data.description || ''}",
      "author": {
        "@type": "Person",
        "name": "UBOAR",
        "url": "https://uboar.net"
      },
      "datePublished": "${post.data.pubDate.toISOString()}",
      ${post.data.updatedDate ? `"dateModified": "${post.data.updatedDate.toISOString()}",` : ''}
      "image": "${articleImage}",
      "publisher": {
        "@type": "Organization",
        "name": "UBOPAGE",
        "logo": {
          "@type": "ImageObject",
          "url": "https://uboar.net/favicon.svg"
        }
      },
      "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "${new URL(`/blog/${post.data.slug}`, Astro.site || 'https://uboar.net').href}"
      },
      ${post.data.tags && post.data.tags.length > 0 ? `"keywords": "${post.data.tags.join(', ')}",` : ''}
      "wordCount": ${post.body ? post.body.split(/\s+/).length : 0}
    }
  </script>
</Layout>