---
import { getCollection } from "astro:content";
import Layout from "@layouts/Layout.astro";
import fs from 'fs';
import path from 'path';

const pageTitle = "ãƒªãƒ³ã‚¯ãƒ„ãƒªãƒ¼";
const allLinks = await getCollection("links");

// contentãƒ•ã‚©ãƒ«ãƒ€ã‹ã‚‰ã‚¢ã‚¤ã‚³ãƒ³ã‚’èª­ã¿è¾¼ã‚€é–¢æ•°
const getIconContent = (iconPath: string) => {
  try {
    const fullPath = path.join(process.cwd(), 'src/content/icons', iconPath);
    return fs.readFileSync(fullPath, 'utf-8');
  } catch (error) {
    console.warn(`Icon not found: ${iconPath}`);
    return null;
  }
};

// ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒªãƒ³ã‚¯ã®ã¿ã‚’å–å¾—ã—ã€å„ªå…ˆåº¦é †ã«ã‚½ãƒ¼ãƒˆ
const activeLinks = allLinks
  .filter(link => link.data.isActive)
  .sort((a, b) => b.data.priority - a.data.priority);

// ã‚«ãƒ†ã‚´ãƒªã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
const groupedLinks = activeLinks.reduce((acc, link) => {
  const category = link.data.category;
  if (!acc[category]) {
    acc[category] = [];
  }
  acc[category].push(link);
  return acc;
}, {} as Record<string, typeof activeLinks>);

// ã‚«ãƒ†ã‚´ãƒªã®æ—¥æœ¬èªåãƒãƒƒãƒ”ãƒ³ã‚°
const categoryNames: Record<string, string> = {
  social: "ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ãƒ¡ãƒ‡ã‚£ã‚¢",
  portfolio: "ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ª", 
  blog: "ãƒ–ãƒ­ã‚°ãƒ»è¨˜äº‹",
  contact: "ãŠå•ã„åˆã‚ã›",
  other: "ãã®ä»–"
};
---

<Layout 
  title={`${pageTitle} - UBO SITE`}
  description="ç§ã®ãƒªãƒ³ã‚¯ãƒ„ãƒªãƒ¼ - ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ãƒ¡ãƒ‡ã‚£ã‚¢ã€ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã€ãƒ–ãƒ­ã‚°ãªã©ã¸ã®ãƒªãƒ³ã‚¯é›†"
  currentPath="/link"
  backgroundPattern="main"
>
  <div class="container">
    <div class="py-8">
      <div class="max-w-md mx-auto">
        <!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="text-center mb-12 motion-preset-slide-down-sm">
          <div class="w-32 h-32 mx-auto mb-6 flex items-center justify-center relative">
            <div class="w-full h-full bg-gradient-primary rounded-full flex items-center justify-center shadow-lg" style="box-shadow: var(--glow-primary)">
              <span class="text-bg-primary text-4xl font-bold">ğŸš€</span>
            </div>
          </div>
          <h1 class="text-4xl font-bold mb-4 motion-preset-typewriter">My Links</h1>
          <p class="text-text-secondary text-lg">ã™ã¹ã¦ã®ãƒªãƒ³ã‚¯ãŒã“ã“ã«ã‚ã‚Šã¾ã™</p>
        </div>

        <!-- ãƒªãƒ³ã‚¯ä¸€è¦§ -->
        <div class="space-y-8">
          {Object.entries(groupedLinks).map(([category, links], categoryIndex) => (
            <div class="motion-preset-slide-up-sm" style={`animation-delay: ${0.3 + categoryIndex * 0.1}s`}>
              <h2 class="text-2xl font-bold text-center mb-6 text-orange-main">
                {categoryNames[category] || category}
              </h2>
              <div class="space-y-4">
                {links.map((link, linkIndex) => (
                  <a
                    href={link.data.url}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="card block w-full p-6 hover:scale-105 transition-all duration-300 group motion-preset-slide-up-sm"
                    style={`animation-delay: ${0.4 + categoryIndex * 0.1 + linkIndex * 0.05}s; ${link.data.backgroundColor ? `background: linear-gradient(135deg, ${link.data.backgroundColor}, ${link.data.backgroundColor}dd);` : ''}`}
                  >
                    <div class="flex items-center justify-between">
                      <div class="flex items-center space-x-4">
                        {/* ã‚¢ã‚¤ã‚³ãƒ³è¡¨ç¤º - ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«å„ªå…ˆã€æ¬¡ã«çµµæ–‡å­— */}
                        {link.data.iconImage ? (
                          <div 
                            class="flex-shrink-0 transition-transform group-hover:scale-110"
                            style={`width: ${link.data.iconSize || 32}px; height: ${link.data.iconSize || 32}px;`}
                            set:html={getIconContent(link.data.iconImage)}
                          />
                        ) : link.data.icon && (
                          <span class="text-3xl flex-shrink-0 transition-transform group-hover:scale-110">{link.data.icon}</span>
                        )}
                        <div>
                          <h3 
                            class="font-semibold text-lg group-hover:text-orange-light transition-colors"
                            style={link.data.textColor ? `color: ${link.data.textColor}` : ''}
                          >
                            {link.data.title}
                          </h3>
                          {link.data.description && (
                            <p 
                              class="text-sm mt-1 text-text-muted"
                              style={link.data.textColor ? `color: ${link.data.textColor}; opacity: 0.8` : ''}
                            >
                              {link.data.description}
                            </p>
                          )}
                        </div>
                      </div>
                      <svg 
                        class="w-6 h-6 text-orange-accent group-hover:text-orange-light transition-all transform group-hover:translate-x-1" 
                        fill="none" 
                        stroke="currentColor" 
                        viewBox="0 0 24 24"
                      >
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                      </svg>
                    </div>
                  </a>
                ))}
              </div>
            </div>
          ))}
        </div>

        <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
        <div class="text-center mt-16 pb-8 motion-preset-slide-up-sm" style="animation-delay: 1s">
          <p class="text-sm text-text-muted">
            Â© 2025 UBO SITE. Made with 
            <a href="https://astro.build" target="_blank" class="text-orange-main hover:text-orange-light transition-colors">
              Astro
            </a>
          </p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯åŠ¹æœ
    document.addEventListener('DOMContentLoaded', () => {
      const linkElements = document.querySelectorAll('a[href^="http"]');
      
      linkElements.forEach(link => {
        link.addEventListener('click', (e) => {
          const target = e.currentTarget as HTMLElement;
          
          // ã‚¯ãƒªãƒƒã‚¯åŠ¹æœ
          target.style.transform = 'scale(0.95)';
          setTimeout(() => {
            target.style.transform = '';
          }, 150);
        });
      });
    });
  </script>

</Layout>